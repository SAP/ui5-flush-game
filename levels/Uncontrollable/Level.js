sap.ui.define(["sap/ui/base/Object","sap/ui/Device"],function(e,t){"use strict";var i,a,s,n,o,r,h,l,d,u,c,m,v;var y,g;var p=false;var _=30;var f=100;var b=20;var w=30;var x=60;var k=6;var T;var D;var L;var A;var S;var B;var M;var C=[];var P;var E;var O=3;var j=true;var G={PLAYER:1,PLAYERBOTTOM:2,RENDERMANAGER:3,CONTROL:4};var R={POLYGON:1,CIRCLE:2};var I;var F=[];var Y=Box2D.Common.Math.b2Vec2;var X=Box2D.Dynamics.b2BodyDef;var V=Box2D.Dynamics.b2Body;var N=Box2D.Dynamics.b2FixtureDef;var U=Box2D.Dynamics.b2World;var W=Box2D.Collision.Shapes.b2PolygonShape;var $=Box2D.Collision.Shapes.b2CircleShape;var q=Box2D.Dynamics.b2DebugDraw;var H=Box2D.Dynamics.b2ContactListener;var Q={spawnGameObject:function(e,t,a){var s;if(e.spriteSheet){s=new createjs.Sprite(e.spriteSheet,e.spriteSheetAnimation);s.spriteSheetAnimation=e.spriteSheetAnimation}else if(e.assetId){s=new createjs.Bitmap(n.getResult(e.assetId))}else if(e.control){s=new createjs.Bitmap;s.image=e.control._image}if(e.width)s.width=e.width;if(e.height)s.height=e.height;if(e.x)s.x=e.x;if(e.y)s.y=e.y;if(e.regX){s.regX=e.regX}else{s.regX=parseInt(e.width/2)}if(e.regY){s.regY=e.regY}else{s.regY=parseInt(e.height/2)}if(e.scaleX)s.scaleX=e.scaleX;if(e.scaleY)s.scaleY=e.scaleY;if(e.control)s.control=e.control;if(e.assetId)s.assetId=e.assetId;if(e.snapToPixel)s.snapToPixel=e.snapToPixel;if(e.mouseEnabled)s.mouseEnabled=e.mouseEnabled;if(e.gameObjectType)s.gameObjectType=e.gameObjectType;if(e.shapeType)s.shapeType=e.shapeType;if(e.density)s.density=e.density;if(e.isStaticBody)s.isStaticBody=e.isStaticBody;if(e.gameObjectType==G.PLAYER){a=s;y=a}i.addChild(s);if(e.hasBox2dBody===true){return z.createGameObjectBodyAndActor(s,t)}return s}};var z=function(){var e=1,n=20,r=1/n;var T=Date.now();var S=0;var B=[];var O=[];var j=[];var Q=true;var z=function(){I=new U(new Y(0,6),true);var i=new q;i.SetSprite(h);i.SetDrawScale(_);i.SetFillAlpha(.7);i.SetLineThickness(1);i.SetFlags(q.e_shapeBit|q.e_jointBit);I.SetDebugDraw(i);var n=function(e){var i=e[0],a=e[1];if(Math.abs(g.GetLinearVelocity().y)<6&&g.GetPosition().y>(t.system.phone&&t.orientation.landscape?k/2:k)){g.ApplyForce(new Y(0,a*f*5),g.GetPosition());P=Date.now();C.push(g.GetPosition().x);if(C.length>3){var s=0;for(var n=0;n<C.length-2;n++){s+=C[n+1]-C[n]}if(Math.abs(s)>2){E=Date.now();p=false}}if(C.length>10){C.shift()}}g.ApplyForce(new Y(i*f,i*f),g.GetPosition());g.SetLinearDamping(.5);g.SetFixedRotation(true)};d=function(e){switch(e.key){case"ArrowLeft":case"a":this._movement[0]=-1;break;case"ArrowRight":case"d":this._movement[0]=1;break;case"ArrowUp":case"w":if(!D.getSoundManager().isPlaying("Raketenduese")){D.getSoundManager().play("Raketenduese",undefined,undefined,.5)}y.gotoAndPlay("fly");this._movement[1]=-1;break;case"ArrowDown":case"s":this._movement[0]=1;break;case" ":break;case"Enter":break}if(this._movement[0]||this._movement[1]){clearInterval(this._iIntervalMove);this._iIntervalMove=setInterval(function(){n(this._movement)}.bind(this),b)}}.bind(this);u=function(e){switch(e.key){case"ArrowLeft":case"a":this._movement[0]=0;clearInterval(this._iIntervalMove);break;case"ArrowRight":case"d":this._movement[0]=0;clearInterval(this._iIntervalMove);break;case"ArrowUp":case"w":D.getSoundManager().stop("Raketenduese");y.gotoAndPlay("run");this._movement[1]=0;clearInterval(this._iIntervalMove);break;case"ArrowDown":case"s":this._movement[0]=0;clearInterval(this._iIntervalMove);break;case" ":break;case"Enter":break}}.bind(this);this.shakeMagnet=function(){if(!this._bShakeRunning){this._bShakeRunning=true;createjs.Tween.get(l).to({scaleX:1.2,scaleY:1.2},50).to({rotation:l.rotation+25,rotationDir:-1},50).to({scaleX:1,scaleY:1},50).to({rotation:l.rotation},50).to({scaleX:.8,scaleY:.8},50).to({rotation:l.rotation+25,rotationDir:-1},50).to({scaleX:1,scaleY:1},50).to({rotation:l.rotation},50);setTimeout(function(){this._bShakeRunning=false}.bind(this),400)}}.bind(this);this.calculateMouseMovement=function(e){var t=e.offsetX||e.targetTouches[0].clientX;var i=e.offsetY||e.targetTouches[0].clientY;if(t<y.x+50){this._movement[0]=-1}else{this._movement[0]=1}if(i<y.y+50){this._movement[1]=-1;if(!D.getSoundManager().isPlaying("Raketenduese")){D.getSoundManager().play("Raketenduese",undefined,undefined,.5)}y.gotoAndPlay("fly")}else{this._movement[1]=1;D.getSoundManager().stop("Raketenduese");y.gotoAndPlay("run")}}.bind(this);c=function(e){if(this._bLastDownStillActive){return}setTimeout(function(){this._bLastDownStillActive=false}.bind(this),20);this._bLastDownStillActive=true;this._bMousePressed=true;this.shakeMagnet();this.calculateMouseMovement(e);if(this._movement[0]||this._movement[1]){clearInterval(this._iIntervalMove);n(this._movement);this._iIntervalMove=setInterval(function(){n(this._movement)}.bind(this),e.targetTouches?x:w)}if(!D.getSoundManager().isPlaying("shootingCharge1")){D.getSoundManager().play("shootingCharge1")}}.bind(this);m=function(e){if(this._bMousePressed){this.shakeMagnet();this.calculateMouseMovement(e)}}.bind(this);v=function(){this._bMousePressed=false;clearInterval(this._iIntervalMove);this._movement=[0,0];D.getSoundManager().stop("shootingCharge1");D.getSoundManager().stop("Raketenduese");y.gotoAndPlay("run")}.bind(this);this._movement=[0,0];document.addEventListener("keydown",d);document.addEventListener("keyup",u);o.addEventListener("mousedown",c);o.addEventListener("mousemove",m);o.addEventListener("mouseup",v);o.addEventListener("touchdown",c);o.addEventListener("touchmove",c);o.addEventListener("touchend",v);o.addEventListener("mousedown",c);o.addEventListener("mousemove",m);o.addEventListener("mouseup",v);o.addEventListener("touchdown",c);o.addEventListener("touchmove",c);o.addEventListener("touchend",v);var r=new H;r.BeginContact=function(e){if(e.GetFixtureA().m_body.m_userData&&e.GetFixtureB().m_body.m_userData&&e.GetFixtureA().m_body.m_userData.skin&&e.GetFixtureB().m_body.m_userData.skin&&(e.GetFixtureA().m_body.m_userData.skin.gameObjectType===G.PLAYER&&!e.GetFixtureA().m_userData&&e.GetFixtureB().m_body.m_userData.skin.gameObjectType===G.CONTROL||e.GetFixtureB().m_body.m_userData.skin.gameObjectType===G.PLAYER&&!e.GetFixtureB().m_userData&&e.GetFixtureA().m_body.m_userData.skin.gameObjectType===G.CONTROL)){if(Q){Q=false;A=setTimeout(function(){Q=true},500);D.score(-100*L/10,[g.GetPosition().x*_+25,g.GetPosition().y*_+25]);D.triggerEvent("Haha");M=Date.now()}}};I.SetContactListener(r);var T=new N;T.density=.3;T.restitution=.5;T.shape=new W;T.shape.SetAsBox(a/_,e/_);var S=new X;S.type=V.b2_staticBody;S.position.x=0;S.position.y=s/_;var B=I.CreateBody(S);B.CreateFixture(T);var O=new N;O.shape=new W;O.shape.SetAsBox(e/_,s/_);var j=new X;j.type=V.b2_staticBody;j.position.x=0;j.position.y=s/_;var R=I.CreateBody(j);R.CreateFixture(O)};var J=function(e,t){this.body=e;this.skin=t;this.update=function(){this.skin.rotation=this.body.GetAngle()*(180/Math.PI);this.skin.x=this.body.GetWorldCenter().x*_;this.skin.y=this.body.GetWorldCenter().y*_};F.push(this)};var K=function(e,t){var i=new N;i.density=e.density;i.restitution=.1;var a=new X;if(e.shapeType==R.POLYGON){i.shape=new W;if(e.gameObjectType==G.PLAYER){i.shape.SetAsBox(e.width/_/2,(e.height-30)/_/2)}else{i.shape.SetAsBox(e.width/_/2,e.height/_/2)}a.position.x=(e.x+e.width/2)/_;a.position.y=(e.y+e.height/2)/_}if(e.shapeType==R.CIRCLE){i.shape=new $(e.width/2/_);a.position.x=e.x/_;a.position.y=e.y/_}if(e.isStaticBody===true){a.type=V.b2_staticBody}else{a.type=V.b2_dynamicBody}var s=I.CreateBody(a);s.skin=e;if(e.gameObjectType==G.PLAYER){t=s;g=t}if(e.gameObjectType==G.PLAYER){var n=new N;n.density=e.density;n.restitution=.1;n.shape=new W;n.shape.SetAsOrientedBox(e.width/_/2,1/_/2,new Y(0,e.height/2/_));n.userData=true;s.CreateFixture(n)}var o=s.CreateFixture(i);o.skin=e;if(e.gameObjectType==G.CONTROL){var r=2*L/10;var h=Math.random()*r+1.5;s.ApplyImpulse(new Y(-4*s.m_mass*h,-4.3*s.m_mass*h*.6),s.GetPosition())}var l=new J(s,e);s.SetUserData(l);if(e.gameObjectType==G.CONTROL||e.assetId==="ALVTable"){O.push(s)}else{j.push(s)}return s};var Z=function(e){if(e){i.removeChild(e.skin);F.splice(F.indexOf(e),1)}};var ee=function(){var e=Date.now();var t=e-T;S+=t;T=e;while(S>=n){for(var i=0,a=B.length;i<a;i++){Z(B[i].GetUserData());B[i].SetUserData(null);I.DestroyBody(B[i])}B=[];for(var i=0,a=F.length;i<a;i++){F[i].update()}I.Step(r,10,10);S-=n;I.ClearForces();I.m_debugDraw.m_sprite.graphics.clear();I.DrawDebugData();if(O.length>30){B.push(O[0]);O.splice(0,1)}}};var te=function(e){if(e){r=0}else{r=1/n}T=Date.now()};return{setup:z,update:ee,createGameObjectBodyAndActor:K,pauseResume:te}}();return e.extend("flush.game.levels.Uncontrollable",{constructor:function(e,t,i){D=e;this._oCanvas=t[0];this._oDebugCanvas=t[0];this._oControlManager=i},tick:function(e){if(Math.random()<.1){C.shift()}if(j){var t=e.delta/1e3;this._skyline1.x=this._skyline1.x-t*30;if(this._skyline1.x+this._skyline1.image.width*this._skyline1.scaleX<=0){this._skyline1.x=1238}if(this._skyline1.x<=-a){this._skyline1.x=0}this._skyline2.x=this._skyline2.x-t*30;if(this._skyline2.x+this._skyline2.image.width*this._skyline2.scaleX<=0){this._skyline2.x=1238}if(this._skyline2.x<=0){this._skyline2.x=a}var n=e.delta/1e3;this._hill1.x=this._hill1.x-n*60;if(this._hill1.x+this._hill1.image.width*this._hill1.scaleX<=0){this._hill1.x=1464}if(this._hill1.x<=-a){this._hill1.x=0}this._hill2.x=this._hill2.x-n*60;if(this._hill2.x+this._hill2.image.width*this._hill2.scaleX<=0){this._hill2.x=1464}if(this._hill2.x<=0){this._hill2.x=a}z.update();i.update();O++;var r=Math.floor(60-L*2);if(O%r===0){O=0;var h=this._oControlManager.getContent();var d=h[Math.floor(Math.abs(Math.random())*h.length)];D.getSoundManager().play("Controlshot");Q.spawnGameObject({gameObjectType:G.CONTROL,shapeType:R.POLYGON,control:d,width:d._image.width,height:d._image.height,x:a,y:s-300,snapToPixel:true,mouseEnabled:false,density:1,isStaticBody:false,hasBox2dBody:true},this._playerBody,this._player)}}l.x=i.mouseX;l.y=i.mouseY;l.x=Math.max(0,l.x);l.x=Math.min(l.x,o.width-75);l.y=Math.max(0,l.y);l.y=Math.min(l.y,o.height-75);if(i.mouseX===0&&i.mouseY===0){l.x=-200;l.y=-200}var u=y.x+50-l.x-50;var c=y.y+75-l.y-80;l.rotation=Math.atan2(u,c*-1)*180/Math.PI;i.setChildIndex(l,i.getNumChildren()-1)},dropTable:function(){if(this._oALVTable){if(this._oALVTable.GetUserData()){i.removeChild(this._oALVTable.GetUserData().skin);F.splice(F.indexOf(this._oALVTable.GetUserData()),1)}this._oALVTable.SetUserData(null);I.DestroyBody(this._oALVTable)}this._oALVTable=Q.spawnGameObject({assetId:"ALVTable",shapeType:R.POLYGON,width:500,height:373,x:g.GetPosition().x*_-250,y:s-800,snapToPixel:true,mouseEnabled:false,density:15,isStaticBody:false,hasBox2dBody:true},this._playerBody,this._player);this._oALVTable.ApplyImpulse(new Y(Math.random()*5,10),this._oALVTable.GetPosition())},init:function(){return new Promise(function(e,t){T=e;o=this._oCanvas.getDomRef();r=this._oDebugCanvas.getDomRef();h=r.getContext("2d");createjs.MotionGuidePlugin.install();i=new createjs.Stage(o);createjs.Touch.enable(i);i.snapPixelsEnabled=true;a=this._oCanvas.$().width();s=this._oCanvas.$().height();z.setup();var l=function(){S=setTimeout(function(){var e=Date.now()-M;var t=Date.now()-P;e=Math.floor(e/1e3);t=Math.floor(t/1e3);if(t<3&&e>0){D.score(Math.max(10,e*100*L/20),[g.GetPosition().x*_-25,g.GetPosition().y*_+25]);D.triggerEvent("Awesome")}l()},3e3)};P=Date.now()-3e3;M=Date.now()+3e3;l();var d=function(){B=setTimeout(function(){var e=(Date.now()-E)/1e3;if(e>3&&!p){D.triggerEvent("PointsCritical","Move!",[g.GetPosition().x*_-25,g.GetPosition().y*_+25]);p=true}if(e>6){setTimeout(function(){D.score(-1e3,[g.GetPosition().x*_-25,g.GetPosition().y*_+25]);D.triggerEvent("Ohno");E=Date.now()+5e3;p=false},1e3);this.dropTable();D.getSoundManager().play("devil");D.getSoundManager().play("shoot")}d()}.bind(this),3e3)}.bind(this);E=Date.now()+1e4;d();var u=sap.ui.require.toUrl("flush/game/levels/Uncontrollable/assets");n=new createjs.LoadQueue(false);n.on("complete",this.onLoadingCompleted,this);n.crossOrigin="";n.loadFile({id:"robot",src:u+"/robo.png"});n.loadFile({id:"skyline",src:u+"/skyline.png"});n.loadFile({id:"playerSprite",src:u+"/spritesheet_CodiFaehrtUndSpringt.png"});n.loadFile({id:"phoenix",src:u+"/phoenix.png"});n.loadFile({id:"cloud",src:u+"/clouds.png"});n.loadFile({id:"hill",src:u+"/hill.png"});n.loadFile({id:"ALVTable",src:u+"/ALVTable.png"});n.loadFile({id:"magnet",src:u+"/magnet.png"})}.bind(this))},onLoadingCompleted:function(){createjs.Ticker.addEventListener("tick",createjs.Tween);this._hill1=new createjs.Bitmap(n.getResult("hill"));this._hill1.width=1464;this._hill1.height=768;this._hill1.alpha=.1;this._hill1.x=0;this._hill1.y=s-this._hill1.height+80;i.addChild(this._hill1);this._hill2=new createjs.Bitmap(n.getResult("hill"));this._hill2.width=1464;this._hill2.height=768;this._hill2.alpha=.1;this._hill2.x=a+194;this._hill2.y=s-this._hill2.height+80;i.addChild(this._hill2);this._skyline1=new createjs.Bitmap(n.getResult("skyline"));this._skyline1.width=1238;this._skyline1.height=475;this._skyline1.alpha=.3;this._skyline1.x=0;this._skyline1.y=s-this._skyline1.height+7;i.addChild(this._skyline1);this._skyline2=new createjs.Bitmap(n.getResult("skyline"));this._skyline2.width=1238;this._skyline2.height=475;this._skyline2.alpha=.3;this._skyline2.x=a;this._skyline2.y=s-this._skyline2.height+7;i.addChild(this._skyline2);l=new createjs.Bitmap(n.getResult("magnet"));l.regX=52;l.regY=83;l.mouseEnabled=false;i.addChild(l);Q.spawnGameObject({spriteSheet:new createjs.SpriteSheet({framerate:1,images:[n.getResult("playerSprite")],frames:{height:153,count:28,width:99,spacing:10},animations:{run:[0,0,"stay",1.5],jump:[20,26],fly:[27,27]}}),spriteSheetAnimation:"run",gameObjectType:G.PLAYER,shapeType:R.POLYGON,width:"99",height:"143",x:100,y:s-2e3,snapToPixel:true,mouseEnabled:false,density:1,isStaticBody:false,hasBox2dBody:true});this._robot=new createjs.Bitmap(n.getResult("robot"));this._robot.x=a-186;this._robot.y=s-143;i.addChild(this._robot);var e=new createjs.Bitmap(n.getResult("phoenix"));e.scaleX=-1;e.regY=250;e.regX=200;i.addChild(e);createjs.Tween.get(e).to({guide:{path:[-200,-200,0,200,400,200,600,200,800,-200]}},7e3);var t=new createjs.Bitmap(n.getResult("cloud"));t.y=-50;t.scaleX=1.240234375;t.alpha=.5;i.addChild(t);this._oControlManager.updateAllControlImages().then(function(){createjs.Ticker.setFPS(30);createjs.Ticker.addEventListener("tick",this.tick.bind(this));T();D.getSoundManager().play("Adlerschrei")}.bind(this))},exit:function(){return new Promise(function(e,t){if(i){i.removeAllChildren();createjs.Ticker.removeAllEventListeners();createjs.Tween.removeAllTweens();i=null}clearTimeout(A);clearTimeout(S);clearTimeout(B);document.removeEventListener("keydown",d);document.removeEventListener("keyup",u);o.removeEventListener("mousedown",c);o.removeEventListener("mousemove",m);o.removeEventListener("mouseup",v);o.removeEventListener("touchdown",c);o.removeEventListener("touchmove",m);o.removeEventListener("touchend",v);e()}.bind(this))},setDifficulty:function(e){L=Math.min(e,50)}})});