sap.ui.define(["sap/ui/base/Object"],function(e){"use strict";var t,i,a,r;var s={b2Vec2:Box2D.Common.Math.b2Vec2,b2BodyDef:Box2D.Dynamics.b2BodyDef,b2Body:Box2D.Dynamics.b2Body,b2FixtureDef:Box2D.Dynamics.b2FixtureDef,b2Fixture:Box2D.Dynamics.b2Fixture,b2World:Box2D.Dynamics.b2World,b2MassData:Box2D.Collision.Shapes.b2MassData,b2PolygonShape:Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape:Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw:Box2D.Dynamics.b2DebugDraw};var o=false;var n=false;var h=25;var d=20;var u=32;var l=.7;var c,m,f,y,v;return e.extend("flush.game.levels.PlopARobot",{constructor:function(e,t,i){if(o===false){o=true;this._oGame=e;this._oCanvas=t[0];this._oControlManager=i;this._boundKeyDown=this._fnKeyDown.bind(this);this._boundKeyUp=this._fnKeyUp.bind(this);this._keyboardInputX=0;this._keyboardInputY=0}},init:function(){return new Promise(function(e){this._fnInitResolve=e;if(o===true&&n===false){n=true;var r=[{src:"CodiBlau.png",id:"codi0"},{src:"CodiGruen.png",id:"codi1"},{src:"CodiLila.png",id:"codi2"},{src:"CodiOrange.png",id:"codi3"},{src:"RenderManagerRot.png",id:"render0"},{src:"hammer.png",id:"hammer"}];a=new createjs.LoadQueue(false);a.addEventListener("complete",this.onLoadingCompleted.bind(this));a.loadManifest(r,true,sap.ui.require.toUrl("flush/game/levels/PlopARobot/assets")+"/");t=this._oCanvas.$().width();i=this._oCanvas.$().height();document.addEventListener("keydown",this._boundKeyDown);document.addEventListener("keyup",this._boundKeyUp)}}.bind(this))},setupPhysics:function(){v=new s.b2World(new s.b2Vec2(0,20),true);var e=new s.b2FixtureDef;e.density=1;e.friction=.5;e.restitution=0;e.shape=new s.b2PolygonShape;e.shape.SetAsBox(t/u*.6,10/u);var a=new s.b2BodyDef;a.type=s.b2Body.b2_staticBody;a.position.x=t/2/u;a.position.y=(i+10)/u;v.CreateBody(a).CreateFixture(e)},exit:function(){return new Promise(function(e,t){if(r){r.removeAllChildren();createjs.Ticker.removeAllEventListeners();createjs.Tween.removeAllTweens();r=null}document.removeEventListener("keydown",this._boundKeyDown);document.removeEventListener("keyup",this._boundKeyUp);e()}.bind(this))},setDifficulty:function(e){this._iDifficulty=Math.min(e,50);this._difficultyFactor=.2+.7/e},onLoadingCompleted:function(){r=new createjs.Stage(this._oCanvas.getId());createjs.Touch.enable(r);r.autoClear=false;r.alpha=1;setTimeout(function(){o=false;n=false},3e3);f=[];y=0;createjs.Ticker.addEventListener("tick",createjs.Tween);this.myCursor=new createjs.Bitmap(a.getResult("hammer"));this.myCursor.mouseEnabled=false;r.addChild(this.myCursor);r.mouseX=this._oCanvas.$().width()/2;r.mouseY=this._oCanvas.$().height()/2;r.addChild(new createjs.Shape).graphics.beginFill("#5C89A1").drawRect(0,0,t,i);var e=new createjs.SpriteSheetBuilder;var s=new lib.Balls;s.actionsEnabled=false;s.circle.visible=false;e.addMovieClip(s,null,l);m=e.build();c=[];for(var h=0,d=m.getNumFrames();h<d;h++){s.gotoAndStop(h);c.push({frame:h,radius:s.circle.scaleX*100*l/2})}this.setupPhysics();createjs.Ticker.setFPS(30);createjs.Ticker.useRAF=true;createjs.Ticker.timingMode=createjs.Ticker.RAF;this._oControlManager.updateAllControlImages().then(function(){createjs.Ticker.addEventListener("tick",this.tick.bind(this))}.bind(this));this._fnInitResolve()},_fnKeyDown:function(e){var t=e.key;if(t===" "||t==="Enter"){this.boom();return}switch(t){case"ArrowLeft":case"a":this._iIntervalLeft=setInterval(function(){this._keyboardInputX-=h}.bind(this),d);break;case"ArrowRight":case"d":this._iIntervalRight=setInterval(function(){this._keyboardInputX+=h}.bind(this),d);break;case"ArrowUp":case"w":this._iIntervalUp=setInterval(function(){this._keyboardInputY-=h}.bind(this),d);break;case"ArrowDown":case"s":this._iIntervalDown=setInterval(function(){this._keyboardInputY+=h}.bind(this),d);break}},_fnKeyUp:function(e){switch(e.key){case"ArrowLeft":case"a":clearInterval(this._iIntervalLeft);break;case"ArrowRight":case"d":clearInterval(this._iIntervalRight);break;case"ArrowUp":case"w":clearInterval(this._iIntervalUp);break;case"ArrowDown":case"s":clearInterval(this._iIntervalDown);break}},_hammered:function(){createjs.Tween.get(this.myCursor).to({rotation:60,rotationDir:-1},100).to({rotation:30},100).to({rotation:10,rotationDir:-1},100)},tick:function(e){v.Step(e.delta/1e3,10,10);if(y++%2==0&&v.GetBodyCount()<t*i/(125*125)/(l*l)){this.resetBall(this.addBall(0))}for(var a=v.GetBodyList();a;a=a.GetNext()){var s=a.userData;if(!s){continue}var o=a.GetPosition();var n=s.sprite;n.x=o.x*u;n.y=o.y*u;n.rotation=a.GetAngle()/Math.PI*180;if(s.type!=0){n.alpha-=.03}if(n.y>i||n.x<-s.radius*1.5||n.x>t+s.radius*1.5||n.alpha<=0){this.resetBall(s)}}this.removeBalls();if(this._previousMouseX!==r.mouseX){this.myCursor.x=r.mouseX-120}else{this.myCursor.x+=this._keyboardInputX;this._keyboardInputX=0}if(this._previousMouseY!==r.mouseY){this.myCursor.y=r.mouseY-80}else{this.myCursor.y+=this._keyboardInputY;this._keyboardInputY=0}this._previousMouseX=r.mouseX;this._previousMouseY=r.mouseY;this.myCursor.x=Math.max(0,this.myCursor.x);this.myCursor.x=Math.min(this.myCursor.x,this._oCanvas.$().width()-75);this.myCursor.y=Math.max(0,this.myCursor.y);this.myCursor.y=Math.min(this.myCursor.y,this._oCanvas.$().height()-75);r.setChildIndex(this.myCursor,r.getNumChildren()-1);r.update(e)},addBall:function(e,t){t=t||1;var i=Math.max(this._iDifficulty/10,1)*.75;t*=1/i;var o=c[Math.random()*2+e*2|0];var n=o.radius*l*t;var h=new s.b2FixtureDef;h.density=.1;h.friction=.5;h.restitution=.6;h.shape=new s.b2CircleShape(o.radius/u);var d=new s.b2BodyDef;d.type=s.b2Body.b2_dynamicBody;var f=v.CreateBody(d);f.CreateFixture(h);var y;if(e<=1){if(Math.random()<this._difficultyFactor){var b=Math.floor(Math.random()*2*Math.max(this._iDifficulty/10,1));y=new createjs.Bitmap(a.getResult("render"+b))}else if(Math.random()<.3){var p=this._oControlManager.getContent();var C=p[Math.floor(Math.abs(Math.random())*p.length)];y=new createjs.Bitmap(C._image)}else{var _=Math.floor(Math.random()*4*Math.max(this._iDifficulty/10,1));y=new createjs.Bitmap(a.getResult("codi"+_))}}else{y=new createjs.Sprite(m);y.gotoAndStop(o.frame)}y.scaleX=y.scaleY=t;if(e===0){y.addEventListener("mousedown",this.boom.bind(this))}r.addChild(y);var g={def:o,fixDef:h,bodyDef:d,body:f,sprite:y,radius:n,type:e};f.userData=y.userData=g;return g},resetBall:function(e){var i=e.body;if(e.type===0){i.SetPositionAndAngle(new s.b2Vec2(Math.random()*t/u|0,-(e.radius*2+100*l)/u),0);i.SetLinearVelocity(new s.b2Vec2(Math.random()*20-10),0);i.SetAngularVelocity(0)}},removeBall:function(e){f.push(e)},removeBalls:function e(){while(f.length){var t=f.pop();v.DestroyBody(t.body);r.removeChild(t.sprite);t.body=null}},boom:function(e){var t=false;var i;var a;if(!e){var o=r.getObjectsUnderPoint(this.myCursor.x+120,this.myCursor.y+80);for(var n=0;n<o.length;n++){if(o[n].image){i=o[n].userData;a=[this.myCursor.x+120,this.myCursor.y+80];if(o[n].image.src.indexOf("Codi")>=0){t=true;break}}}}else{t=e.currentTarget.image.src.indexOf("Codi")>=0;i=e.target.userData;a=[e.rawX,e.rawY]}if(!i){return}this._oGame.getSoundManager().play("hammer");this._hammered();if(t){this._oGame.triggerEvent("Ohno");this._oGame.score(-100*this._iDifficulty/5,a)}else{this._oGame.triggerEvent("Awesome");this._oGame.score(100*this._iDifficulty/10,a)}this.resetBall(i);var h=(50+l*400)/u;var d=l*l*120;var c=a[0]/u;var m=a[1]/u;var f=i.def.frame;for(var n=0;n<8;n++){var y=Math.random()*.7+.5;var b=Math.random()*Math.PI*2;var p=i.radius*(.5+Math.random()*.5);var C=c+Math.cos(b)*p/u;var _=m+Math.sin(b)*p/u;var g=this.addBall(Math.random()<.3?3:f+1,y);if(g){g.body.SetPositionAndAngle(new s.b2Vec2(C,_),b)}}for(var w=v.GetBodyList();w;w=w.GetNext()){i=w.userData;if(!i){continue}var D=w.GetPosition();var M=D.x-c;var x=D.y-m;var p=Math.sqrt(M*M+x*x);if(p>=h){continue}var B=(h-p)/h*d*(i.type==0?1:.01);var b=Math.atan2(x,M);w.ApplyImpulse(new s.b2Vec2(Math.cos(b)*B,Math.sin(b)*B),D)}}})});