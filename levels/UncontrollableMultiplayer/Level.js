sap.ui.define(["sap/ui/base/Object","./physics/box2DHelper","./helper/time","./helper/random","sap/ui/model/json/JSONModel"],function(e,t,a,i,s){"use strict";var r,n,o,l,h;var d=[];var g=[[0,0],[0,0]];return e.extend("flush.game.levels.UncontrollableMultiplayer",{constructor:function(e,t,a){this.oGame=e;this.oCanvas=t[0];this.oDebugCanvas=t[1];this.oControlManager=a},init:function(){return new Promise((e,i)=>{l=this.oCanvas.getDomRef();h=this.oDebugCanvas.getDomRef();createjs.MotionGuidePlugin.install();this.stage=new createjs.Stage(l);this.stage.snapPixelsEnabled=true;r=this.oCanvas.$().width();n=this.oCanvas.$().height();var d=function(e,i){if(e){var s=t.playerSkin(e-1);if(!s.recoveringFromHit&&!i.blocked&&!(i.createdBy===e&&Date.now()-i.createdAt<500)){s.recoveringFromHit=true;a.setTimeout(function(){if(s){s.recoveringFromHit=false;s.gotoAndPlay("stay")}},2e3);if(s.currentAnimation==="fly"){s.gotoAndPlay("flyHit")}else{s.gotoAndPlay("stayHit")}if(!jQuery.sap.getUriParameters().get("game-debug")){this.oGame.hit(e)}this.oGame.getSoundManager().play("goodHit");this.oGame.getSoundManager().play("badHit");this.oGame.getSoundManager().play("hammer")}}}.bind(this);var g=function(e,a){a.image=o.getResult("phoenix"+(e===1?"Blue":"Red"));t.playerSkin(e-1).playerLvl++;this.oGame.getSoundManager().play("goodHit");this.oGame.triggerEvent("PickPhoenix",t.playerSkin(e-1).playerLvl,[e===1?"begin":"end","center"])}.bind(this);var c=function(e,t){if(this.stage&&e){this.stage.removeChild(e.skin);t.splice(t.indexOf(e),1)}}.bind(this);t.init(l,h,d,g,this._iDifficulty,c,this.oGame.getSoundManager());o=new createjs.LoadQueue(false);var y=sap.ui.require.toUrl("flush/game/levels/UncontrollableMultiplayer")+"/";var u=new s;u.attachRequestCompleted(t=>{var a=t.getSource().getData();o.loadManifest(a,true,y+"assets/");o.on("complete",()=>{this.onLoadingCompleted().then(e)},this)});u.loadData(y+"levelManifest.json")})},onLoadingCompleted:function(){var e=o.getResult("hill");var s={width:1464,height:768,y:n-768+80,alpha:.1};this._hill1=new createjs.Bitmap(e);Object.assign(this._hill1,s,{x:0});this.stage.addChild(this._hill1);this._hill2=new createjs.Bitmap(e);Object.assign(this._hill2,s,{x:r+194});this.stage.addChild(this._hill2);var l={1:"bgLasVegas",2:"bgBarcelona",3:"bgUI5",4:"bgSkyline",5:"bgWolkenkratzer",6:"bgBaeume",7:"bgSpinne"};var h=l[i.getInt(1,8).toString()];var c=o.getResult(h);var y={width:1238,height:475,y:n-475+7,alpha:.5};this._skyline1=new createjs.Bitmap(c);this.stage.addChild(Object.assign(this._skyline1,y,{x:0}));this._skyline2=new createjs.Bitmap(c);this.stage.addChild(Object.assign(this._skyline2,y,{x:r}));var u=function(e){return{spriteSheet:new createjs.SpriteSheet({framerate:1,images:["Stay","Fly","FlyHit1","FlyHit2","FlyHit3","FlyHit4","StayHit1","StayHit2","StayHit3","StayHit4"].map(function(t){return o.getResult(e+t)}),frames:{height:350,count:10,width:280,regX:90,regY:90},animations:{stay:[0,0],fly:[1,1],flyHit:[2,5,"flyHit",.5],stayHit:[6,9,"stayHit",.5]}}),spriteSheetAnimation:"stay",gameObjectType:t.types.gameObjects.PLAYER,shapeType:t.types.shapes.POLYGON,width:133,scaleX:133/200,height:200,scaleY:200/300,y:0,snapToPixel:true,mouseEnabled:false,density:1,isStaticBody:false,hasBox2dBody:true,playerLvl:1,directionChanges:0}};var m={x:0,playerNumber:1};this.spawnGameObject(Object.assign(m,u("robotBlue")));var f={x:r-133,playerNumber:2};this.spawnGameObject(Object.assign(f,u("robotRed")));var p={width:256,height:316,alpha:1,scaleX:.4,scaleY:.4,y:0};var b=Object.assign(new createjs.Bitmap(o.getResult("bomb1")),p,{x:5});this.stage.addChild(b);b.image=o.getResult("bomb"+this.oGame.getPlayerEnergySegment(1));var v=Object.assign(new createjs.Bitmap(o.getResult("bomb1")),p,{x:r-115});this.stage.addChild(v);v.image=o.getResult("bomb"+this.oGame.getPlayerEnergySegment(2));a.setInterval(function(){b.image=o.getResult("bomb"+this.oGame.getPlayerEnergySegment(1));v.image=o.getResult("bomb"+this.oGame.getPlayerEnergySegment(2))}.bind(this),300);var k=new createjs.Bitmap(o.getResult("cloud"));k.y=-50;k.scaleX=1.240234375;k.alpha=.5;this.stage.addChild(k);var w=new createjs.Bitmap(o.getResult("phoenix"));w.scaleX=-1;w.regY=250;w.regX=200;this.stage.addChild(w);w.visible=true;this.oGame.getSoundManager().play("Adlerschrei");a.setInterval(()=>{createjs.Tween.get(w).to({guide:{path:[-400,-200,-200,-100,0,0,200,100,400,200,600,200,800,100,1e3,0,1200,-200]}},6e3);a.setTimeout(()=>{this.spawnGameObject({gameObjectType:t.types.gameObjects.CONTROLPACKAGE,assetId:"phoenixGrey",width:100,height:100,scaleX:100/933,scaleY:100/974,regX:933/2,regY:974/2,x:r/2,y:100,snapToPixel:true,mouseEnabled:false,density:1,isStaticBody:false,hasBox2dBody:true,shapeType:t.types.shapes.CIRCLE})},4e3)},1e4);return this.oControlManager.updateAllControlImages().then(()=>{createjs.Ticker.setFPS(30);this.tickFn=this.tick.bind(this);createjs.Ticker.addEventListener("tick",this.tickFn);var e=[];var i=false;var s=false;var r=t.playerSkin(0);var n=t.playerSkin(1);this.fnKeyDown=function(e){function i(){jQuery("#flush---game--page-canvas").toggleClass("display-none");jQuery("#debugCanvas").toggleClass("display-inline")}switch(e.key){case"a":g[0][0]=-1;break;case"ArrowLeft":g[1][0]=-1;break;case"d":g[0][0]=1;break;case"ArrowRight":g[1][0]=1;break;case"w":var s=t.playerSkin(0);if(s&&!this.oGame.getSoundManager().isPlaying("Raketenduese")){this.oGame.getSoundManager().play("Raketenduese",undefined,undefined,.7)}if(s.recoveringFromHit){s.gotoAndPlay("flyHit")}else{s.gotoAndPlay("fly")}g[0][1]=-1;break;case"ArrowUp":var s=t.playerSkin(1);if(s&&!this.oGame.getSoundManager().isPlaying("Raketenduese")){this.oGame.getSoundManager().play("Raketenduese",undefined,undefined,.7)}if(s.recoveringFromHit){s.gotoAndPlay("flyHit")}else{s.gotoAndPlay("fly")}g[1][1]=-1;break;case"s":g[0][1]=1;break;case"ArrowDown":g[1][1]=1;break;case"v":var s=t.playerSkin(0);if(s&&!this._laserPlayer1Block){this.spawnLaserParticle(1);this._laserPlayer1Block=true;a.setTimeout(function(){this._laserPlayer1Block=false}.bind(this),3e3)}break;case"0":var s=t.playerSkin(1);if(s&&!this._laserPlayer2Block){this.spawnLaserParticle(2);this._laserPlayer2Block=true;a.setTimeout(function(){this._laserPlayer2Block=false}.bind(this),3e3)}break;case"Enter":var s=t.playerSkin(1);if(s&&!d[1]){this.oGame.getSoundManager().play("shootingCharge1");d[1]=new Date;s.arm.gotoAndPlay(2)}break;case" ":var s=t.playerSkin(0);if(s&&!d[0]){this.oGame.getSoundManager().play("shootingCharge2");d[0]=new Date;s.arm.gotoAndPlay(2)}break;case"t":i();break}}.bind(this);this.fnKeyUp=function(e){switch(e.key){case"a":g[0][0]=g[0][0]!==1?0:1;break;case"ArrowLeft":g[1][0]=g[1][0]!==1?0:1;break;case"d":g[0][0]=g[0][0]!==-1?0:-1;break;case"ArrowRight":g[1][0]=g[1][0]!==-1?0:-1;break;case"w":var a=t.playerSkin(0);if(a){this.oGame.getSoundManager().stop("Raketenduese");if(a.recoveringFromHit){a.gotoAndPlay("stayHit")}else{a.gotoAndPlay("stay")}}g[0][1]=g[0][1]!==1?0:1;break;case"ArrowUp":var a=t.playerSkin(1);if(a){this.oGame.getSoundManager().stop("Raketenduese");if(a.recoveringFromHit){a.gotoAndPlay("stayHit")}else{a.gotoAndPlay("stay")}}g[1][1]=g[1][1]!==1?0:1;break;case"s":g[0][1]=g[0][1]!==-1?0:-1;break;case"ArrowDown":g[1][1]=g[1][1]!==-1?0:-1;break;case"v":break;case"0":break;case"Enter":var a=t.playerSkin(1);if(a){this.oGame.getSoundManager().stop("shootingCharge1");a.arm.gotoAndPlay("default");this.throwControl(2,Date.now()-d[1]);d[1]=false}break;case" ":var a=t.playerSkin(0);if(a){this.oGame.getSoundManager().stop("shootingCharge2");a.arm.gotoAndPlay("default");this.throwControl(1,Date.now()-d[0]);d[0]=false}break;case"b":var a=t.playerSkin(0);if(a){this.throwBomb(1)}break;case",":var a=t.playerSkin(1);if(a){this.throwBomb(2)}break}}.bind(this);document.addEventListener("keydown",this.fnKeyDown);document.addEventListener("keyup",this.fnKeyUp);setTimeout(()=>{this.throwControl(1,3e3/this._iDifficulty);this.throwControl(2,3e3/this._iDifficulty)},1e3)})},spawnGameObject:function(e){var i;if(e.spriteSheet){i=new createjs.Sprite(e.spriteSheet,e.spriteSheetAnimation)}else if(e.assetId){i=new createjs.Bitmap(o.getResult(e.assetId))}else if(e.control){i=new createjs.Bitmap;i.image=e.control._image;a.setTimeout(()=>{if(i&&i.image){i.image=e.control._imageBlocked;i.blocked=true}},2e3)}if(e.regX){i.regX=e.regX}else{i.regX=parseInt(e.width/2,10)}if(e.regY){i.regY=e.regY}else{i.regY=parseInt(e.height/2,10)}Object.keys(e).forEach(function(t){i[t]=e[t]});this.stage.addChild(i);if(e.spriteSheet){var s="blue";if(e.playerNumber===2){s="red"}var r=new createjs.SpriteSheet({framerate:1,images:[1,2,3,4,5,6,7,8].map(function(e){return o.getResult(s+"Arm"+e)}),frames:{height:150,count:8,width:200},animations:{default:[0,0],loading:[1,7,"loading",30]}});var n=new createjs.Sprite(r,"default");n.scaleX=.66;n.scaleY=.66;this.stage.addChild(n);i.arm=n}if(e.hasBox2dBody===true){return t.createGameObjectBodyAndActor(i,this._iDifficulty)}return i},updateDirection:function(e,t){if(e.x>=t.x){e.direction=-1;t.direction=1}else{e.direction=1;t.direction=-1}if(e.playerNumber===1&&(e.direction===1&&e.scaleX<0||e.direction===-1&&e.scaleX>0)||e.playerNumber===2&&(e.direction===-1&&e.scaleX<0||e.direction===1&&e.scaleX>0)){e.scaleX*=-1;e.arm.scaleX*=-1;e.directionChanges+=1}},throwControl:function(e,i){var s=this.oControlManager.getContent();var r=t.playerSkin(e-1).playerLvl;var n=s[r>s.length?s.length-1:r-1];var o=t.playerSkin(0);var l=t.playerSkin(1);var h=e===1?o:l;var d=e===1?l:o;this.updateDirection(h,d);if(!h.controlThrowingCooldown){h.controlThrowingCooldown=true;a.setTimeout(function(){if(h){h.controlThrowingCooldown=false}},200);var g=h.x;var c=h.y;if(h.direction===-1){g-=h.width/2+n._image.width;g-10}this.oGame.getSoundManager().play("Controlshot");this.spawnGameObject({gameObjectType:t.types.gameObjects.CONTROL,shapeType:t.types.shapes.POLYGON,control:n,width:n._image.width,height:n._image.height,x:g,y:c,snapToPixel:true,mouseEnabled:false,density:1,isStaticBody:false,hasBox2dBody:true,direction:h.direction,createdBy:e,createdAt:Date.now(),loadedTime:i})}},throwBomb:function(e){if(this.oGame.hasBombEnergy(e)){t.applyBombEffect(this.oGame.getSoundManager());this.oGame.getSoundManager().play("shoot")}else{this.oGame.getSoundManager().play("badHit")}this.oGame.bomb(e)},updateRobotArms:function(){t.playerSkin().forEach(function(e){var t=0;if(e.currentAnimation==="flyHit"||e.currentAnimation==="stayHit"){e.arm.visible=false;return}else if(e.currentAnimation==="fly"){t=-15}e.arm.visible=true;var a=1;if(e.directionChanges%2===1){a=-1}if(e.direction===1){e.arm.x=e.x-70*a;e.arm.y=e.y-20+t}else{e.arm.x=e.x-70*a;e.arm.y=e.y-20+t}})},tick:function(e){var a=e.delta/1e3;this._skyline1.x=this._skyline1.x-a*30;if(this._skyline1.x+this._skyline1.image.width*this._skyline1.scaleX<=0){this._skyline1.x=1238}if(this._skyline1.x<=-r){this._skyline1.x=0}this._skyline2.x=this._skyline2.x-a*30;if(this._skyline2.x+this._skyline2.image.width*this._skyline2.scaleX<=0){this._skyline2.x=1238}if(this._skyline2.x<=0){this._skyline2.x=r}var i=e.delta/1e3;this._hill1.x=this._hill1.x-i*60;if(this._hill1.x+this._hill1.image.width*this._hill1.scaleX<=0){this._hill1.x=1464}if(this._hill1.x<=-r){this._hill1.x=0}this._hill2.x=this._hill2.x-i*60;if(this._hill2.x+this._hill2.image.width*this._hill2.scaleX<=0){this._hill2.x=1464}if(this._hill2.x<=0){this._hill2.x=r}this.fnMove(g,a);t.update();if(this.stage){this.updateRobotArms();this.stage.update()}},fnMove:function(e,a){e.forEach(function(e,i){var s=t.playerBody(i).GetPosition();var n=t.playerSkin(i);if(s&&s.x!==undefined&&s.y!==undefined){var o=e[0],l=e[1];var h=t.playerBody(i).GetLinearVelocity();h.x=o*a*200;if(o>0){h.x=Math.min(h.x,10);if(i===0&&n.x+n.width/2>r/2){h.x=0}}else if(o<0){h.x=Math.max(h.x,-10);if(i===1&&n.x-n.width/2<r/2){h.x=0}}if(o===0){h.x=0}h.y=h.y+l*a*50;if(l===0||n.y<=50||n.recoveringFromHit){h.y=1}else if(l>0){h.y=Math.min(h.y,10)}else if(l<0){h.y=Math.max(h.y,-10)}if(jQuery.sap.getUriParameters().get("debug-move")){jQuery.sap.log("velocity x: "+h.x+", velocity y:"+h.y+", direction x:"+o+", direction y:"+l)}t.playerBody(i).SetFixedRotation(true);t.playerBody(i).SetLinearVelocity(h)}})},spawnLaserParticle:function(e){var i=(new Date).getTime();var s;var r=t.playerSkin(0);var n=t.playerSkin(1);var o=e===1?r:n;var l=e===1?n:r;this.updateDirection(o,l);var h=a.setInterval(function(){s=(new Date).getTime();if(s-i>=1e3){clearInterval(h)}else{this.oGame.getSoundManager().play("laser");var a={assetId:e===1?"laser_blue":"laser_red",gameObjectType:t.types.gameObjects.LASERPARTICLE,shapeType:t.types.shapes.POLYGON,width:71.5,height:67.5,x:o.direction===1?o.x-25:o.x-160,y:o.y-50,regX:0,regY:33.75,snapToPixel:true,mouseEnabled:false,density:1,isStaticBody:false,hasBox2dBody:true,direction:o.direction,createdBy:e,createdAt:Date.now()};this.spawnGameObject(a)}}.bind(this),150)},exit:function(){return new Promise(function(e,i){if(this.stage){createjs.Tween.removeAllTweens();this.stage.removeAllChildren();createjs.Ticker.removeAllEventListeners();t.destroy();delete this.stage}a.clearAll();document.removeEventListener("keydown",this.fnKeyDown);document.removeEventListener("keyup",this.fnKeyUp);e()}.bind(this))},setDifficulty:function(e){this._iDifficulty=Math.min(e,50)}})});